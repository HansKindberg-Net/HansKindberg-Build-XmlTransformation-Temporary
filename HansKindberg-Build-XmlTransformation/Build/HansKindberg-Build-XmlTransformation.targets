<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<IsWebApplicationProject Condition="$(IsWebApplicationProject) == '' AND $(WebApplicationProjectTypeGuid) != '' AND $(ProjectTypeGuids) != ''">$(ProjectTypeGuids.Contains($(WebApplicationProjectTypeGuid)))</IsWebApplicationProject>
		<IsWebApplicationProject Condition="$(IsWebApplicationProject) == ''">False</IsWebApplicationProject>
	</PropertyGroup>
	<UsingTask AssemblyFile="$(MicrosoftWebPublishingTasksAssemblyFile)" Condition="!$(IsWebApplicationProject)" TaskName="Microsoft.Web.Publishing.Tasks.TransformXml" />
	<PropertyGroup>
		<BuildDependsOn Condition="$(TransformOnBuild)">
			$(BuildDependsOn);
			TransformXmlFiles;
		</BuildDependsOn>
	</PropertyGroup>
	<PropertyGroup>
		<CollectFilesForProfileTransformWebConfigsDependsOn>
			CollectXmlFilesToTransformOnPublishProfile;
			$(CollectFilesForProfileTransformWebConfigsDependsOn);
		</CollectFilesForProfileTransformWebConfigsDependsOn>
	</PropertyGroup>
	<Target Name="CollectFilesForProfileTransformWebConfigs" DependsOnTargets="$(CollectFilesForProfileTransformWebConfigsDependsOn)" Condition="'$(CollectFilesForProfileTransformWebConfigs)' != 'false'">
		<ItemGroup>
			<ProfileWebConfigsToTransform Include="@(XmlFileToTransformOnPublishProfile)">
				<TransformFile>%(Transform)</TransformFile>
				<TransformFileFolder>$(ProfileTransformWebConfigIntermediateLocation)\assist</TransformFileFolder>
				<TransformOriginalFolder>$(ProfileTransformWebConfigIntermediateLocation)\original</TransformOriginalFolder>
				<TransformOutputFile>%(Destination)</TransformOutputFile>
				<TransformScope>$([System.IO.Path]::GetFullPath('$(WPPAllFilesInSingleFolder)\%(DestinationRelativePath)'))</TransformScope>
			</ProfileWebConfigsToTransform>
			<_ProfileWebConfigsToTransformOuputs Include="@(ProfileWebConfigsToTransform->'%(TransformOutputFile)')" />
		</ItemGroup>
		<CallTarget Targets="$(OnAfterCollectFilesForProfileTransformWebConfigs)" RunEachTargetSeparately="False" />
	</Target>
	<PropertyGroup>
		<CollectWebConfigsToTransformDependsOn>
			CollectXmlFilesToTransformOnPublishBuild;
			$(CollectWebConfigsToTransformDependsOn);
		</CollectWebConfigsToTransformDependsOn>
	</PropertyGroup>
	<Target Name="CollectWebConfigsToTransform" DependsOnTargets="$(CollectWebConfigsToTransformDependsOn)" Condition="'$(CollectWebConfigsToTransform)' != 'false'">
		<ItemGroup>
			<WebConfigsToTransform Include="@(XmlFileToTransformOnPublishBuild)">
				<TransformFile>%(Transform)</TransformFile>
				<TransformFileFolder>$(TransformWebConfigIntermediateLocation)\assist</TransformFileFolder>
				<TransformOriginalFolder>$(TransformWebConfigIntermediateLocation)\original</TransformOriginalFolder>
				<TransformOutputFile>%(Destination)</TransformOutputFile>
				<TransformScope>$([System.IO.Path]::GetFullPath('$(WPPAllFilesInSingleFolder)\%(DestinationRelativePath)'))</TransformScope>
			</WebConfigsToTransform>
			<_WebConfigsToTransformOuputs Include="@(WebConfigsToTransform->'%(TransformOutputFile)')" />
		</ItemGroup>
		<CallTarget Targets="$(OnAfterCollectWebConfigsToTransform)" RunEachTargetSeparately="False" />
	</Target>
	<PropertyGroup>
		<CollectXmlFilesToTransformOnBuildDependsOn></CollectXmlFilesToTransformOnBuildDependsOn>
	</PropertyGroup>
	<Target Name="CollectXmlFilesToTransformOnBuild" DependsOnTargets="$(CollectXmlFilesToTransformOnBuildDependsOn)">
		<CollectBuildTransformation
			AppConfigDestinationDirectory="$(XmlTransformationIntermediate)"
			Files="@(Content);@(EmbeddedResource);@(None);@(Resource)"
			SeparateSourceIsRequired="$(IsWebApplicationProject)"
			TransformName="$(Configuration)"
			XmlFileExtensions="@(XmlFileExtension)"
			XmlTransformationMaps="@(XmlTransformationMap)"
		>
			<Output TaskParameter="FilesToTransform" ItemName="XmlFileToTransformOnBuild" />
		</CollectBuildTransformation>
		<ItemGroup>
			<_AppConfigToTransformOnBuild Include="@(XmlFileToTransformOnBuild)" Condition="%(IsAppConfig) == 'true'" />
		</ItemGroup>
		<PropertyGroup>
			<AppConfig>$(XmlTransformationIntermediate)App.config</AppConfig>
		</PropertyGroup>
	</Target>
	<PropertyGroup>
		<CollectXmlFilesToTransformOnPublishBuildDependsOn></CollectXmlFilesToTransformOnPublishBuildDependsOn>
	</PropertyGroup>
	<Target Name="CollectXmlFilesToTransformOnPublishBuild" DependsOnTargets="$(CollectXmlFilesToTransformOnPublishBuildDependsOn)">
		<CollectBuildTransformation
			DestinationDirectory="$(TransformWebConfigIntermediateLocation)\transformed"
			Files="@(FilesForPackagingFromProject)"
			SeparateSourceIsRequired="$(IsWebApplicationProject)"
			TransformName="$(Configuration)"
			XmlFileExtensions="@(XmlFileExtension)"
			XmlTransformationMaps="@(XmlTransformationMap)"
		>
			<Output TaskParameter="FilesToTransform" ItemName="XmlFileToTransformOnPublishBuild" />
		</CollectBuildTransformation>
		<Copy
			Condition="!Exists('%(XmlFileToTransformOnPublishBuild.Identity)')"
			DestinationFiles="%(XmlFileToTransformOnPublishBuild.Identity)"
			SourceFiles="%(XmlFileToTransformOnPublishBuild.Source)"
		/>
	</Target>
	<PropertyGroup>
		<CollectXmlFilesToTransformOnPublishProfileDependsOn></CollectXmlFilesToTransformOnPublishProfileDependsOn>
	</PropertyGroup>
	<Target Name="CollectXmlFilesToTransformOnPublishProfile" DependsOnTargets="$(CollectXmlFilesToTransformOnPublishProfileDependsOn)">
		<CollectPublishTransformation
			DestinationDirectory="$(ProfileTransformWebConfigIntermediateLocation)\transformed"
			Files="@(FilesForPackagingFromProject)"
			SeparateSourceIsRequired="$(IsWebApplicationProject)"
			TransformName="$(PublishProfileName)"
			XmlFileExtensions="@(XmlFileExtension)"
			XmlTransformationMaps="@(XmlTransformationMap)"
		>
			<Output TaskParameter="FilesToTransform" ItemName="XmlFileToTransformOnPublishProfile" />
		</CollectPublishTransformation>
		<Copy
			Condition="!Exists('%(XmlFileToTransformOnPublishProfile.Identity)')"
			DestinationFiles="%(XmlFileToTransformOnPublishProfile.Identity)"
			SourceFiles="%(XmlFileToTransformOnPublishProfile.Source)"
		/>
	</Target>
	<PropertyGroup>
		<TransformXmlFilesDependsOn>
			CollectXmlFilesToTransformOnBuild;
		</TransformXmlFilesDependsOn>
	</PropertyGroup>
	<Target
		Name="TransformXmlFiles"
		DependsOnTargets="$(TransformXmlFilesDependsOn)"
	>
		<!--
		<TransformXml
			Condition="%(XmlFileToTransformOnBuild.PreTransform) != ''"
			Destination="%(XmlFileToTransformOnBuild.Destination)"
			Source="%(XmlFileToTransformOnBuild.PreTransformSource)"
			Transform="%(XmlFileToTransformOnBuild.PreTransform)"
		/>
		-->
		<Message
			Condition="%(XmlFileToTransformOnBuild.PreTransform) != ''"
			Importance="$(MessageImportance)"
			Text="Pre-transformed %(XmlFileToTransformOnBuild.PreTransformSource) using %(XmlFileToTransformOnBuild.PreTransform) into %(XmlFileToTransformOnBuild.Destination)."
		/>
		<!--
		<TransformXml
			Destination="%(XmlFileToTransformOnBuild.Destination)"
			Source="%(XmlFileToTransformOnBuild.Identity)"
			Transform="%(XmlFileToTransformOnBuild.Transform)"
		/>
		-->
		<Message
			Importance="$(MessageImportance)"
			Text="Transformed %(XmlFileToTransformOnBuild.Identity) using %(XmlFileToTransformOnBuild.Transform) into %(XmlFileToTransformOnBuild.Destination)."
		/>
	</Target>
</Project>